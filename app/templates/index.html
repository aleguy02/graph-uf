<!DOCTYPE html>
<html lang="en">

<head>
  {% include 'meta.html' %}
</head>

<body>
  {% include 'nav_header.html' %}

  <div class="container">
    <div class="hero-section fade-in">
      <h1 class="hero-title">{{ title }}</h1>
      <p class="hero-subtitle">Discover which courses you can unlock by completing your target course</p>
    </div>

    <div class="main-card fade-in">
      <div class="info-box">
        <h4><i class="fas fa-info-circle"></i>How it works</h4>
        <p>Enter a course you're considering or interested in and any you've already completed. We'll show what that course unlocks and whether you already satisfy the other prerequisites.</p>
        <h4><i class="fas fa-info-circle"></i>Tip</h4>
        <p>You can also enter a lower-level course you've already taken as a target to open show a wider range of course unlocks!</p>
      </div>

      <form id="temp-form-name" action="{{ url_for('main.unlocks_redirect') }}" method="post">
        <div class="form-section">
          <h3><i class="fas fa-target"></i>Target Course</h3>
          <div class="form-group">
            <input id="tentative-code" name="tentative-code" required placeholder="e.g., COP3530, MAC2311, CHM2045">
            <small class="help-text">Use standard course codes.</small>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas"></i>Completed Courses</h3>
          <div class="form-group">
            <div id="course-inputs">
              {% for i in range(1, 6) %}
                <div class="course-input">
                  <input id="code{{ i }}" name="code{{ i }}" placeholder="Code {{ i }}" />
                </div>
              {% endfor %}
            </div>
            <div class="course-controls">
              <button type="button" id="add-courses-btn" class="btn-control">
                <i class="fas fa-plus"></i> Add More
              </button>
              <button type="button" id="rm-courses-btn" class="btn-control">
                <i class="fas fa-minus"></i> Remove
              </button>
            </div>
            <small class="help-text">Add any courses you've successfully completed. This helps us filter what's immediately available.</small>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas"></i>Semester & View Options</h3>
          <div class="form-group">
            <label for="semester">Semester:</label>
            <select id="semester" name="semester">
              {% for sem in semesters %}
                <option value="{{ sem }}" {% if sem == default_semester %}selected{% endif %}>
                  {{ sem|upper }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="view_type">Data Structure:</label>
            <select id="view_type" name="view_type">
              <option value="tcm">Transitive Closure Map</option>
              <option value="graph">Graph</option>
            </select>
          </div>
        </div>

        <button type="submit" class="submit-btn">
          <i class="fas fa-unlock"></i>
          Show what it unlocks
        </button>
      </form>
    </div>
  </div>

  <!-- Config passed from Flask for JS without inline templating inside JS -->
  <div id="config" data-max-courses="{{ max_courses_taken }}" hidden></div>

  <script>
    // Server-provided previously completed courses (from cookie)
    const PRECOMPLETED = JSON.parse('{{ completed_courses | tojson | safe }}');
    const configEl = document.getElementById('config');
    const maxCourses = parseInt(configEl.dataset.maxCourses, 10);
    const minCourses = 5;
    const step = 5;
    const courseInputsDiv = document.getElementById('course-inputs');
    const addBtn = document.getElementById('add-courses-btn');
    const rmBtn = document.getElementById('rm-courses-btn');

    function createCourseInput(index) {
      const div = document.createElement('div');
      div.className = 'course-input';
      const input = document.createElement('input');
      input.id = 'code' + index;
      input.name = 'code' + index;
      input.placeholder = 'Code ' + index;
      div.appendChild(input);
      return div;
    }

    addBtn.addEventListener('click', function() {
      const currentCount = courseInputsDiv.querySelectorAll('input').length;
      if (currentCount >= maxCourses) return;
      const nextCount = Math.min(currentCount + step, maxCourses);
      for (let i = currentCount + 1; i <= nextCount; i++) {
        courseInputsDiv.appendChild(createCourseInput(i));
      }
      updateButtonStates();
    });

    rmBtn.addEventListener('click', function() {
      const currentCount = courseInputsDiv.querySelectorAll('input').length;
      if (currentCount <= minCourses) return;
      const removeCount = Math.min(step, currentCount - minCourses);
      for (let i = 0; i < removeCount; i++) {
        courseInputsDiv.removeChild(courseInputsDiv.lastElementChild);
      }
      updateButtonStates();
    });

    function updateButtonStates() {
      const currentCount = courseInputsDiv.querySelectorAll('input').length;
      rmBtn.disabled = currentCount <= minCourses;
      addBtn.disabled = currentCount >= maxCourses;
    }

    // Helper to ensure at least n inputs exist (adding in step-sized batches without exceeding max)
    function ensureInputCount(n) {
      let currentCount = courseInputsDiv.querySelectorAll('input').length;
      while (currentCount < n) {
        for (let i = 0; i < 5; i++) {
          courseInputsDiv.appendChild(createCourseInput(currentCount + 1));
          currentCount++;
        }
      }
    }

    // Populate any pre-completed courses from cookie
    if (Array.isArray(PRECOMPLETED) && PRECOMPLETED.length) {
      ensureInputCount(Math.max(minCourses, PRECOMPLETED.length));
      const inputs = courseInputsDiv.querySelectorAll('input');
      PRECOMPLETED.forEach((code, idx) => {
        if (idx < inputs.length) {
          inputs[idx].value = code;
        }
      });
    }

    // Initial state after potential population
    updateButtonStates();

    // Basic form validation
    const CODE_RE = /^[A-Z]{3,4}\d{4}[A-Z]?/;

    document.getElementById('temp-form-name').addEventListener('submit', function(e) {
      e.preventDefault();

      const tentativeCode = document.getElementById('tentative-code').value.trim();
      if (!CODE_RE.test(tentativeCode)) {
        const el = document.getElementById('tentative-code');
        el.focus();
        el.style.borderColor = '#e74c3c';
        alert("Invalid course code(s)")
        console.log('Invalid tentative code input:', tentativeCode);
        return;
      }

      const validCourses = new Set();
      const courseInputs = document.querySelectorAll('#course-inputs input');

      for (const input of courseInputs) {
        const value = input.value.trim();
        if (value) { // Only process non-empty values
          if (!CODE_RE.test(value)) {
            input.focus();
            input.style.borderColor = '#e74c3c';
            alert("Invalid course code(s)");
            console.log('Invalid course input:', value);
            return;
          }
          validCourses.add(value.toUpperCase());
        }
      }

      const formData = new FormData();
      formData.append('tentative-code', tentativeCode.toUpperCase());
      formData.append('completed-courses', JSON.stringify(Array.from(validCourses)));
      formData.append('semester', document.getElementById('semester').value);
      formData.append('view_type', document.getElementById('view_type').value);

      fetch(this.action, {
        method: 'POST',
        body: formData
      }).then(response => {
        if (response.ok) {
          window.location.href = response.url;
        } else {
          alert('Submission failed');
        }
      }).catch(error => {
        console.error('Error:', error);
        alert('Submission failed');
      });
    });

    // Reset input styling when user interacts with any input
    document.addEventListener('input', function(e) {
      if (e.target.tagName === 'INPUT') {
        e.target.style.borderColor = '';
      }
    });
    document.addEventListener('input', function(e) {
      if (e.target.tagName === 'INPUT') {
        e.target.style.borderColor = '';
      }
    }, true);
  </script>
</body>
</html>
